{% extends "base.html" %}

{% block title %}
Sign In
{% endblock title %}

{% block page_title %}
Sign In
{% endblock page_title %}

{% block content %}
<div class="hero min-h-screen">
    <div class="hero-content flex-col">
        <div class="card w-full max-w-sm shadow-2xl bg-base-100">
            <div class="card-body">
                <h2 class="card-title justify-center mb-4">Welcome Back</h2>
            
                <form 
                    hx-ext="submitjson"
                    hx-post="/login"
                    hx-trigger="submit"
                    hx-target="#result"
                    hx-swap="innerHTML"
                    hx-indicator="#loading"
                    class="space-y-4">
                
                    {% if return_to %}
                    <input type="hidden" name="return_to" value="{{ return_to }}">
                    {% endif %}

                    <div class="form-control">
                        <label class="label" for="email">
                            <span class="label-text">Email Address</span>
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            required
                            class="input input-bordered" 
                            placeholder="Enter your email">
                    </div>

                    <div class="form-control">
                        <label class="label" for="password">
                            <span class="label-text">Password</span>
                        </label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required
                            class="input input-bordered" 
                            placeholder="Enter your password">
                    </div>

                    <div class="form-control mt-6">
                        <button type="submit" class="btn btn-primary">
                            Sign In
                        </button>
                    </div>
                </form>
            
                <div id="loading" class="htmx-indicator text-center mt-4">
                    <span class="loading loading-spinner loading-md"></span>
                    <span class="ml-2">Signing in...</span>
                </div>
                
                <div id="result" class="mt-4"></div>
                
                <div class="text-center mt-4">
                    <p class="text-sm">
                        Don't have an account? 
                        <a href="/sign-up" class="link link-primary">Sign up</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.body.addEventListener('htmx:responseError', function(event) {
    console.log('HTMX Response Error:', event.detail);
    const resultElement = document.getElementById('result');
    if (resultElement && (event.detail.xhr.status === 400 || event.detail.xhr.status === 401 || event.detail.xhr.status === 422)) {
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            const errorMsg = response.message || response.error_message || response.error || 'Login failed';
            resultElement.innerHTML = 
                '<div class="alert alert-error mt-2"><span>Error: ' + errorMsg + '</span></div>';
        } catch (e) {
            resultElement.innerHTML = 
                '<div class="alert alert-error mt-2"><span>Login failed. Please try again.</span></div>';
        }
    }
});

document.body.addEventListener('htmx:afterRequest', function(event) {
    console.log('HTMX After Request:', event.detail);
    if (event.detail.xhr.status === 200 && event.detail.elt.getAttribute('hx-post') === '/login') {
        // Check if there's a redirect location in the response
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.redirect_to) {
                window.location.href = response.redirect_to;
            } else {
                // Default redirect to dashboard
                window.location.href = '/dashboard';
            }
        } catch (e) {
            // Default redirect to dashboard
            window.location.href = '/dashboard';
        }
    }
});
</script>
{% endblock content %}